- id: '1726705397247'
  alias: Front porch sunrise
  description: Turn off the front porch light at sunrise+30
  trigger:
  - platform: sun
    event: sunrise
    offset: 00:30:00
  condition: []
  action:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      device_id: d8b71bed1e3b4fb94eaa80aba6930fbf
  mode: single
- id: '1726705495110'
  alias: front porch sunset
  description: Turn on the front porch light 30 minutes before sunset
  triggers:
  - event: sunset
    offset: -00:30
    trigger: sun
  conditions: []
  actions:
  - action: light.turn_on
    target:
      device_id: d8b71bed1e3b4fb94eaa80aba6930fbf
    data:
      brightness_pct: 100
  mode: single
- id: '1737403000001'
  alias: Steve arrived home
  description: Notify when Steve's phone arrives home
  triggers:
  - platform: state
    entity_id: person.steve
    to: home
  conditions: []
  actions:
  - service: "{{ states('input_text.steve_phone_notify_entity') }}"
    data:
      title: "ðŸ  Welcome Home!"
      message: "Presence detected - arrived at {{ now().strftime('%I:%M %p') }}"
  mode: single
- id: '1737403000002'
  alias: Steve left home
  description: Notify when Steve's phone leaves home
  triggers:
  - platform: state
    entity_id: person.steve
    from: home
  conditions: []
  actions:
  - service: "{{ states('input_text.steve_phone_notify_entity') }}"
    data:
      title: "ðŸš— Left Home"
      message: "Presence lost - left at {{ now().strftime('%I:%M %p') }}"
  mode: single

# Under cabinet lights: ON when dark, OFF when light
# Uses sun elevation + weather (cloudy/foggy/rainy) for overcast days
# Visibility (low = foggy/dark) also triggers lights on
# Replace weather.home with your weather entity if different (Settings > Devices)
- id: '1739120000001'
  alias: Under cabinet lights - dark/light
  description: Turn under cabinet lights on when dark, off when light
  triggers:
  - platform: sun
    event: sunset
    id: sunset
  - platform: sun
    event: sunrise
    id: sunrise
  - platform: sun
    event: sunrise
    offset: "01:00:00"  # 1 hr after sunrise (dawn)
    id: sunrise_1hr
  - platform: sun
    event: sunset
    offset: "-01:00:00"  # 1 hr before sunset
    id: sunset_1hr
  - platform: numeric_state
    entity_id: sun.sun
    value_template: "{{ state_attr('sun.sun', 'elevation') }}"
    above: 18
    below: 23
    id: elevation_twilight
  - platform: numeric_state
    entity_id: sun.sun
    value_template: "{{ state_attr('sun.sun', 'elevation') }}"
    above: -3
    below: 5
    id: elevation_low
  - platform: time_pattern
    minutes: "/15"
    id: every_15
  - platform: time
    at: "22:00:00"
    id: dim_at_10pm
  action:
  - choose:
    # 10pm: dim to 10% if lights are on (then stop)
    - conditions:
      - condition: template
        value_template: "{{ trigger.id == 'dim_at_10pm' }}"
      - condition: state
        entity_id: light.under_cabinet_lights
        state: "on"
      sequence:
      - action: light.turn_on
        target:
          entity_id: light.under_cabinet_lights
        data:
          brightness_pct: 10
    # Sunset / 1 hr before sunset: always turn ON at 100%
    - conditions:
      - condition: template
        value_template: "{{ trigger.id in ['sunset', 'sunset_1hr'] }}"
      sequence:
      - action: light.turn_on
        target:
          entity_id: light.under_cabinet_lights
        data:
          brightness_pct: 100
    # Sunrise / 1 hr after sunrise: always turn OFF
    - conditions:
      - condition: template
        value_template: "{{ trigger.id in ['sunrise', 'sunrise_1hr'] }}"
      sequence:
      - action: light.turn_off
        target:
          entity_id: light.under_cabinet_lights
    # Every 15 min + elevation bands: turn on if dark/overcast, else off
    default:
    - choose:
      - conditions:
        - condition: or
          conditions:
          - condition: state
            entity_id: sun.sun
            state: below_horizon
          - condition: and
            conditions:
            - condition: numeric_state
              entity_id: sun.sun
              value_template: "{{ state_attr('sun.sun', 'elevation') }}"
              below: 20
            - condition: template
              value_template: >-
                {% set w = states('weather.home') | default('sunny') %}
                {% set vis_raw = state_attr('weather.home', 'visibility') %}
                {% set vis = (vis_raw if vis_raw is not none else 999) | float %}
                {{ w in ['cloudy', 'foggy', 'rainy', 'pouring', 'partlycloudy',
                   'lightning-rainy'] or vis < 5 }}
        sequence:
        - action: light.turn_on
          target:
            entity_id: light.under_cabinet_lights
          data:
            brightness_pct: 100
      default:
      - action: light.turn_off
        target:
          entity_id: light.under_cabinet_lights
  mode: restart
